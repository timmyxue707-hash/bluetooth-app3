<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>蓝牙串口示波器 Pro</title>
    
    <!-- PWA 配置：引用同目录下的 manifest.json -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">

    <!-- 样式与库 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    
    <style>
        /* 关键修复 1：禁止下拉刷新 
           overscroll-behavior-y: contain 阻止了浏览器的默认下拉刷新链，
           防止手指下拉时触发页面刷新导致数据丢失。
        */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            touch-action: manipulation; 
            overscroll-behavior-y: contain; 
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col text-slate-800">

    <!-- 顶部导航 -->
    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 shadow-lg sticky top-0 z-30">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2 font-bold text-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                蓝牙示波器 Pro
            </div>
            <div id="statusBadge" class="bg-white/20 px-3 py-1 rounded-full text-xs font-medium flex items-center gap-2 border border-white/30">
                <span class="w-2 h-2 rounded-full bg-gray-300" id="statusDot"></span>
                <span id="statusText">未连接</span>
            </div>
        </div>
    </header>

    <main class="flex-1 p-3 md:p-6 w-full max-w-5xl mx-auto flex flex-col gap-4">

        <!-- 控制面板 -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 fade-in">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <!-- 左侧：通道选择 -->
                <div class="flex items-center gap-3 bg-slate-50 px-3 py-2 rounded-lg border">
                    <span class="text-sm font-bold text-slate-600">通道:</span>
                    <select id="channelSelect" class="bg-transparent text-sm font-bold text-blue-600 outline-none">
                        <option value="1">1</option>
                        <option value="2" selected>2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                </div>

                <!-- 右侧：按钮组 -->
                <div class="flex gap-2 w-full md:w-auto">
                    <button id="connectBtn" class="flex-1 md:flex-none bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow text-sm font-bold transition">连接蓝牙</button>
                    <button id="disconnectBtn" class="hidden flex-1 md:flex-none bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow text-sm font-bold transition">断开</button>
                    <button id="simulateBtn" class="flex-1 md:flex-none bg-white border border-indigo-200 text-indigo-600 hover:bg-indigo-50 px-4 py-2 rounded-lg text-sm font-bold transition">模拟</button>
                </div>
            </div>
        </div>

        <!-- 快捷操作条 -->
        <div class="flex justify-between items-center sticky top-20 z-20 bg-slate-100 py-2">
            <button id="pauseBtn" class="bg-white border text-slate-700 px-4 py-2 rounded-lg shadow-sm flex items-center gap-2 text-xs font-bold transition hover:bg-slate-50">
                <span id="pauseIcon">⏸</span> <span id="pauseText">暂停 (查看历史)</span>
            </button>
            <div class="flex gap-2">
                <button id="clearBtn" class="text-xs bg-white border px-3 py-2 rounded shadow-sm hover:bg-slate-50">清空</button>
                <button id="exportBtn" disabled class="text-xs bg-emerald-600 text-white px-3 py-2 rounded shadow-sm hover:bg-emerald-700 disabled:opacity-50">导出CSV</button>
            </div>
        </div>

        <!-- 图表区域 -->
        <div id="chartsContainer" class="flex flex-col gap-4 pb-20"></div>

        <!-- 日志 -->
        <div class="bg-slate-800 rounded-xl p-3 shadow-inner text-xs font-mono">
            <div class="flex justify-between text-slate-400 border-b border-slate-700 pb-1 mb-1">
                <span>SYSTEM LOG</span>
                <span id="dataCount" class="text-emerald-400">Pts: 0</span>
            </div>
            <div id="logs" class="h-20 overflow-y-auto text-slate-300"></div>
        </div>
    </main>

    <!-- 设置弹窗 -->
    <div id="settingsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden">
            <div class="bg-slate-50 p-4 border-b flex justify-between items-center">
                <h3 class="font-bold text-slate-700" id="modalTitle">设置</h3>
                <button onclick="closeSettings()" class="text-slate-400 text-xl">&times;</button>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">名称</label>
                    <input type="text" id="settingLabel" class="w-full border rounded-lg px-3 py-2 text-sm">
                </div>
                <div>
                    <div class="flex justify-between mb-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase">Y轴范围</label>
                        <label class="flex items-center gap-2 text-sm text-slate-600">
                            <input type="checkbox" id="settingAuto" onchange="toggleManualInputs()"> 自动
                        </label>
                    </div>
                    <div id="manualRangeInputs" class="flex gap-3">
                        <input type="number" id="settingMin" placeholder="Min" class="w-1/2 border rounded-lg px-3 py-2 text-sm">
                        <input type="number" id="settingMax" placeholder="Max" class="w-1/2 border rounded-lg px-3 py-2 text-sm">
                    </div>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-t flex justify-end gap-3">
                <button onclick="closeSettings()" class="text-slate-500 text-sm font-bold px-4">取消</button>
                <button onclick="saveSettings()" class="bg-blue-600 text-white text-sm font-bold px-6 py-2 rounded-lg">保存</button>
            </div>
        </div>
    </div>

    <script>
        // PWA 离线缓存
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    self.addEventListener('install', e => e.waitUntil(caches.open('bt-v4').then(c => c.addAll(['./', 'manifest.json']))));
                    self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
                `;
                const blob = new Blob([swCode], { type: 'application/javascript' });
                navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(console.error);
            });
        }

        // 关键修复 2：监听应用可见性变化，修复后台切回后图表变小的问题
        // 当用户从后台切回前台时，强制所有图表重新调整大小
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                // 延时100ms等待DOM布局完全恢复
                setTimeout(() => {
                    state.charts.forEach(c => c.resize());
                }, 100);
            }
        });

        // 配置
        const TARGET_UUID = 0xFFE0;
        const VISIBLE_POINTS = 50; 
        const COLORS = [
            { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' },
            { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },
            { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
            { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' }
        ];

        // 状态变量
        let state = {
            device: null, gatt: null, char: null,
            isSimulating: false, isPaused: false, simInterval: null,
            buffer: "", totalCount: 0,
            history: [], 
            channels: 2,
            charts: [],
            configs: [],
            editingIdx: -1
        };

        // 初始化
        function init() {
            state.charts.forEach(c => c.destroy());
            state.charts = [];
            const container = document.getElementById('chartsContainer');
            container.innerHTML = '';

            // 补全配置
            while(state.configs.length < state.channels) {
                state.configs.push({ label: `通道 ${state.configs.length+1}`, auto: true, min: 0, max: 100 });
            }

            for(let i=0; i<state.channels; i++) {
                const div = document.createElement('div');
                div.className = "bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden fade-in";
                
                // 关键修复 3：优化 HTML 结构
                // 使用 relative 容器 + absolute canvas 确保图表始终填满容器，防止塌陷
                div.innerHTML = `
                    <div class="bg-slate-50/80 px-4 py-2 flex justify-between items-center border-b">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full" style="background:${COLORS[i%4].border}"></div>
                            <span class="font-bold text-sm text-slate-700" id="title_${i}">${state.configs[i].label}</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openSettings(${i})" class="text-slate-400 hover:text-blue-500">⚙️</button>
                            <button onclick="resetView(${i})" class="text-slate-400 hover:text-green-500">▶</button>
                        </div>
                    </div>
                    <div class="relative w-full h-64"> 
                        <div class="absolute inset-0 p-2">
                            <canvas id="canvas_${i}"></canvas>
                        </div>
                    </div>
                `;
                container.appendChild(div);

                const ctx = document.getElementById(`canvas_${i}`).getContext('2d');
                state.charts.push(new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [{ 
                        data: [], 
                        borderColor: COLORS[i%4].border, 
                        backgroundColor: COLORS[i%4].bg, 
                        borderWidth: 2, fill: true, pointRadius: 0 
                    }]},
                    options: {
                        responsive: true, 
                        maintainAspectRatio: false, // 必须设为 false 才能适配 absolute 容器
                        animation: false,
                        plugins: { 
                            legend: { display: false },
                            zoom: {
                                pan: { enabled: true, mode: 'x', threshold: 10 },
                                zoom: { wheel: { enabled: false }, pinch: { enabled: false }, drag: { enabled: false } }
                            }
                        },
                        scales: {
                            x: { display: true, ticks: { maxRotation:0, autoSkip:true }, min: 0, max: VISIBLE_POINTS },
                            y: { 
                                title: { display:true, text: state.configs[i].label },
                                min: state.configs[i].auto ? undefined : state.configs[i].min,
                                max: state.configs[i].auto ? undefined : state.configs[i].max
                            }
                        }
                    }
                }));
            }
        }

        // 数据解析
        function parseData(str) {
            state.buffer += str;
            if(state.buffer.includes(';')) {
                const groups = state.buffer.split(';');
                state.buffer = groups.pop();
                let hasNew = false;
                groups.forEach(g => {
                    if(!g.trim()) return;
                    const vals = g.split(',').map(Number);
                    if(vals.some(isNaN)) return;
                    
                    state.totalCount++;
                    state.history.push({ id: state.totalCount, vals });
                    
                    state.charts.forEach((c, idx) => {
                        if(idx < vals.length) {
                            c.data.labels.push(state.totalCount);
                            c.data.datasets[0].data.push(vals[idx]);
                        }
                    });
                    hasNew = true;
                });
                if(hasNew) updateView();
            }
        }

        // 视图更新
        function updateView() {
            document.getElementById('dataCount').innerText = `Pts: ${state.totalCount}`;
            if(state.history.length > 0) document.getElementById('exportBtn').removeAttribute('disabled');
            
            if(!state.isPaused) {
                state.charts.forEach(c => {
                    if(state.totalCount > VISIBLE_POINTS) {
                        c.options.scales.x.min = state.totalCount - VISIBLE_POINTS;
                        c.options.scales.x.max = state.totalCount;
                    }
                    c.update('none');
                });
            }
        }

        // 交互逻辑
        window.resetView = (i) => {
            const max = Math.max(state.totalCount, VISIBLE_POINTS);
            state.charts[i].options.scales.x.min = max - VISIBLE_POINTS;
            state.charts[i].options.scales.x.max = max;
            state.charts[i].update();
        };

        // 设置逻辑
        window.openSettings = (i) => {
            state.editingIdx = i;
            document.getElementById('modalTitle').innerText = `通道 ${i+1} 设置`;
            document.getElementById('settingLabel').value = state.configs[i].label;
            document.getElementById('settingAuto').checked = state.configs[i].auto;
            document.getElementById('settingMin').value = state.configs[i].min;
            document.getElementById('settingMax').value = state.configs[i].max;
            toggleManualInputs();
            document.getElementById('settingsModal').classList.remove('hidden');
        };
        window.closeSettings = () => document.getElementById('settingsModal').classList.add('hidden');
        window.toggleManualInputs = () => {
            const auto = document.getElementById('settingAuto').checked;
            document.getElementById('manualRangeInputs').style.opacity = auto ? "0.3" : "1";
            document.getElementById('manualRangeInputs').style.pointerEvents = auto ? "none" : "auto";
        };
        window.saveSettings = () => {
            const i = state.editingIdx;
            const cfg = state.configs[i];
            cfg.label = document.getElementById('settingLabel').value;
            cfg.auto = document.getElementById('settingAuto').checked;
            cfg.min = Number(document.getElementById('settingMin').value);
            cfg.max = Number(document.getElementById('settingMax').value);
            
            document.getElementById(`title_${i}`).innerText = cfg.label;
            state.charts[i].options.scales.y.title.text = cfg.label;
            state.charts[i].options.scales.y.min = cfg.auto ? undefined : cfg.min;
            state.charts[i].options.scales.y.max = cfg.auto ? undefined : cfg.max;
            state.charts[i].update();
            closeSettings();
        };

        // 蓝牙
        document.getElementById('connectBtn').onclick = async () => {
            try {
                addLog('搜索设备...');
                state.device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true, optionalServices: [TARGET_UUID] });
                state.device.addEventListener('gattserverdisconnected', onDisc);
                state.gatt = await state.device.gatt.connect();
                addLog('已连接');
                const svc = await state.gatt.getPrimaryService(TARGET_UUID);
                const chars = await svc.getCharacteristics();
                state.char = chars.find(c => c.properties.notify);
                if(!state.char) throw new Error('无Notify特征值');
                await state.char.startNotifications();
                state.char.addEventListener('characteristicvaluechanged', e => parseData(new TextDecoder().decode(e.target.value)));
                setStatus(true);
            } catch(e) { addLog('错误: '+e.message); setStatus(false); }
        };
        function onDisc() { addLog('断开连接'); setStatus(false); }
        document.getElementById('disconnectBtn').onclick = () => state.device?.gatt?.disconnect();

        function setStatus(conn) {
            const b = document.getElementById('statusBadge');
            const t = document.getElementById('statusText');
            const d = document.getElementById('statusDot');
            if(conn) {
                b.className = b.className.replace('bg-white/20', 'bg-emerald-500/20');
                d.className = d.className.replace('bg-gray-300', 'bg-emerald-500');
                t.innerText = "已连接"; t.className = "text-emerald-700";
                document.getElementById('connectBtn').classList.add('hidden');
                document.getElementById('disconnectBtn').classList.remove('hidden');
                document.getElementById('simulateBtn').classList.add('hidden');
                document.getElementById('channelSelect').disabled = true;
            } else {
                b.className = b.className.replace('bg-emerald-500/20', 'bg-white/20');
                d.className = d.className.replace('bg-emerald-500', 'bg-gray-300');
                t.innerText = "未连接"; t.className = "";
                document.getElementById('connectBtn').classList.remove('hidden');
                document.getElementById('disconnectBtn').classList.add('hidden');
                document.getElementById('simulateBtn').classList.remove('hidden');
                document.getElementById('channelSelect').disabled = false;
            }
        }

        // 模拟
        document.getElementById('simulateBtn').onclick = () => {
            if(state.isSimulating) {
                clearInterval(state.simInterval);
                state.isSimulating = false;
                document.getElementById('simulateBtn').innerText = "模拟";
                addLog('模拟结束');
            } else {
                state.isSimulating = true;
                document.getElementById('simulateBtn').innerText = "停止";
                state.simInterval = setInterval(() => {
                    let v = [];
                    for(let i=0; i<state.channels; i++) v.push((Math.sin(state.totalCount*0.1+i)*20+50+Math.random()*5).toFixed(1));
                    parseData(v.join(',')+';');
                }, 100);
            }
        };

        // 暂停/清空/导出/通道
        document.getElementById('pauseBtn').onclick = function() {
            state.isPaused = !state.isPaused;
            document.getElementById('pauseIcon').innerText = state.isPaused ? "▶" : "⏸";
            document.getElementById('pauseText').innerText = state.isPaused ? "已暂停 (可拖动)" : "暂停 (查看历史)";
            this.className = state.isPaused ? this.className.replace('bg-white', 'bg-amber-100') : this.className.replace('bg-amber-100', 'bg-white');
            if(!state.isPaused) state.charts.forEach((c,i) => resetView(i));
        };
        document.getElementById('clearBtn').onclick = () => {
            state.history = []; state.totalCount = 0;
            state.charts.forEach(c => { c.data.labels=[]; c.data.datasets[0].data=[]; c.update(); });
            updateView();
            document.getElementById('exportBtn').disabled = true;
        };
        document.getElementById('exportBtn').onclick = () => {
            let csv = "Count," + state.configs.slice(0,state.channels).map(c=>c.label).join(',') + "\n";
            state.history.forEach(h => csv += `${h.id},${h.vals.join(',')}\n`);
            const a = document.createElement('a'); a.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv); a.download = 'data.csv'; a.click();
        };
        document.getElementById('channelSelect').onchange = (e) => {
            state.channels = Number(e.target.value);
            init();
        };

        function addLog(s) {
            const d = document.createElement('div');
            d.innerText = `[${new Date().toLocaleTimeString()}] ${s}`;
            document.getElementById('logs').prepend(d);
        }

        init();
        addLog('系统就绪 v4.0');

    </script>
</body>
</html>